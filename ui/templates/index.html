<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TFT ê°€ì´ë“œ</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
  <header>
    <h1>âš”ï¸ TFT ê°€ì´ë“œ</h1>
    <div class="status">
      <span><span class="status-dot" id="captureStatus"></span> ìº¡ì²˜</span>
      <span><span class="status-dot" id="llmStatus"></span> LLM</span>
      <span id="lastUpdated" style="font-size:0.8rem;color:#666"></span>
    </div>
  </header>

  <div class="grid">
    <!-- ë‚´ ì±”í”¼ì–¸ ì„ íƒ -->
    <div class="card full">
      <h2>ğŸ¯ ë‚´ ì±”í”¼ì–¸ ì„ íƒ</h2>
      <div class="input-group">
        <label>ë ˆë²¨:</label>
        <select id="levelSelect">
          {% for l in range(2, 11) %}<option value="{{ l }}" {{ 'selected' if l == 7 }}>{{ l }}</option>{% endfor %}
        </select>
        <label>ê³¨ë“œ:</label>
        <input type="number" id="goldInput" value="0" min="0" max="999" style="width:70px">
        <button class="primary" onclick="getRecommendation()">ì¶”ì²œ ë°›ê¸°</button>
        <button onclick="clearSelection()">ì´ˆê¸°í™”</button>
      </div>
      <div id="championGrid">
        {% for champ in champions %}
        <span class="champ-tag cost-{{ champ.cost }}" data-name="{{ champ.name }}"
              onclick="toggleChamp(this)">{{ champ.name_kr }}</span>
        {% endfor %}
      </div>
    </div>

    <!-- ì¶”ì²œ ë± -->
    <div class="card">
      <h2>ğŸ“Š ì¶”ì²œ ë±</h2>
      <div id="recommendations"><p style="color:#666">ì±”í”¼ì–¸ì„ ì„ íƒí•˜ê³  ì¶”ì²œ ë°›ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”</p></div>
    </div>

    <!-- LLM ë¶„ì„ -->
    <div class="card">
      <h2>ğŸ¤– AI ë¶„ì„</h2>
      <button onclick="getLLMAnalysis()" style="margin-bottom:10px">AI ë¶„ì„ ìš”ì²­</button>
      <div class="llm-response" id="llmResponse">LLM ì„œë²„ ì—°ê²° í›„ ë¶„ì„ì„ ìš”ì²­í•˜ì„¸ìš”</div>
    </div>

    <!-- ìƒëŒ€ ë± ì…ë ¥ -->
    <div class="card">
      <h2>ğŸ‘¥ ìƒëŒ€ ë± ì…ë ¥</h2>
      <div id="opponentInputs">
        <div class="input-group">
          <input type="text" placeholder="ìƒëŒ€1: ì±”í”¼ì–¸ ì˜ë¬¸ëª… ì‰¼í‘œ êµ¬ë¶„" class="opp-input" style="flex:1">
        </div>
      </div>
      <button onclick="addOpponent()" style="font-size:0.8rem">+ ìƒëŒ€ ì¶”ê°€</button>
    </div>

    <!-- ì±”í”¼ì–¸ í’€ -->
    <div class="card">
      <h2>ğŸŠ ì±”í”¼ì–¸ í’€ í˜„í™©</h2>
      <button onclick="loadPool()" style="margin-bottom:10px;font-size:0.8rem">í’€ ì¡°íšŒ</button>
      <div id="poolDisplay"></div>
    </div>

    <!-- ì„¤ì • -->
    <div class="card full">
      <h2>âš™ï¸ ì„¤ì •</h2>
      <div class="settings-row">
        <label>ìº¡ì²˜ ì£¼ê¸°(ì´ˆ):</label>
        <input type="number" id="captureInterval" value="2" min="0.5" max="10" step="0.5" style="width:80px">
        <label>LLM ì„œë²„:</label>
        <input type="text" id="llmUrl" value="http://localhost:11434/v1" style="flex:1">
        <button onclick="saveSettings()">ì €ì¥</button>
      </div>
      <div class="settings-row">
        <button onclick="toggleCapture()">ìº¡ì²˜ í† ê¸€</button>
        <button onclick="updateData()">ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸</button>
      </div>
    </div>
  </div>
</div>

<script>
const costColors = {{ cost_colors | tojson }};
let selectedChamps = new Set();

function toggleChamp(el) {
  const name = el.dataset.name;
  if (selectedChamps.has(name)) {
    selectedChamps.delete(name);
    el.classList.remove('selected');
  } else {
    selectedChamps.add(name);
    el.classList.add('selected');
  }
}

function clearSelection() {
  selectedChamps.clear();
  document.querySelectorAll('.champ-tag.selected').forEach(e => e.classList.remove('selected'));
  document.getElementById('recommendations').innerHTML = '<p style="color:#666">ì±”í”¼ì–¸ì„ ì„ íƒí•˜ê³  ì¶”ì²œ ë°›ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”</p>';
}

function getOpponents() {
  const inputs = document.querySelectorAll('.opp-input');
  return [...inputs].map(i => i.value.split(',').map(s => s.trim()).filter(Boolean)).filter(a => a.length);
}

async function getRecommendation() {
  const level = parseInt(document.getElementById('levelSelect').value);
  const el = document.getElementById('recommendations');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const resp = await fetch('/api/recommend', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({my_champions: [...selectedChamps], opponents: getOpponents(), level})
    });
    const data = await resp.json();
    renderRecommendations(data.recommendations);
  } catch(e) { el.innerHTML = '<p style="color:red">ì˜¤ë¥˜: ' + e.message + '</p>'; }
}

function renderRecommendations(recs) {
  const el = document.getElementById('recommendations');
  if (!recs || !recs.length) { el.innerHTML = '<p style="color:#666">ì¶”ì²œ ê²°ê³¼ ì—†ìŒ</p>'; return; }
  el.innerHTML = recs.slice(0, 8).map(r => {
    const tierClass = 'tier-' + r.tier;
    const needed = r.needed_champions.map(n =>
      `<span class="champ-tag cost-${getCost(n.name)}" style="font-size:0.7rem">${n.name} (${(n.shop_probability*100).toFixed(1)}%)</span>`
    ).join('');
    const owned = r.owned_champions.map(n =>
      `<span class="champ-tag cost-${getCost(n)}" style="font-size:0.7rem;opacity:0.6">${n}</span>`
    ).join('');
    const synergies = (r.synergies||[]).map(s => `<span class="synergy-tag">${s}</span>`).join('');
    return `<div class="deck-card">
      <div class="deck-header">
        <span class="deck-name">${r.deck_name}</span>
        <span class="tier ${tierClass}">${r.tier}</span>
      </div>
      <div class="deck-stats">
        <span>ìŠ¹ë¥  ${r.win_rate}%</span>
        <span>í”½ë¥  ${r.pick_rate}%</span>
        <span>ë§¤ì¹­ ${(r.match_rate*100).toFixed(0)}%</span>
        <span>ìŠ¤ì½”ì–´ ${(r.completion_score*100).toFixed(0)}</span>
      </div>
      <div>${synergies}</div>
      <div style="margin-top:6px"><small style="color:#888">ë³´ìœ :</small> ${owned||'ì—†ìŒ'}</div>
      <div style="margin-top:4px"><small style="color:#888">í•„ìš”:</small> ${needed||'ì™„ì„±!'}</div>
      <div class="match-bar"><div class="match-fill" style="width:${r.match_rate*100}%"></div></div>
    </div>`;
  }).join('');
}

const champData = {{ champions | tojson }};
function getCost(name) {
  const c = champData.find(ch => ch.name === name);
  return c ? c.cost : 1;
}

function addOpponent() {
  const div = document.getElementById('opponentInputs');
  const n = div.children.length + 1;
  const row = document.createElement('div');
  row.className = 'input-group';
  row.innerHTML = `<input type="text" placeholder="ìƒëŒ€${n}: ì±”í”¼ì–¸ ì˜ë¬¸ëª… ì‰¼í‘œ êµ¬ë¶„" class="opp-input" style="flex:1">`;
  div.appendChild(row);
}

async function loadPool() {
  const el = document.getElementById('poolDisplay');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const resp = await fetch('/api/pool', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({opponents: getOpponents()})
    });
    const data = await resp.json();
    let html = '';
    for (const [cost, champs] of Object.entries(data.pool)) {
      const color = costColors[cost] || '#808080';
      html += `<h3 style="color:${color};margin:8px 0 4px">${cost}ì½”ìŠ¤íŠ¸</h3><div class="pool-grid">`;
      champs.forEach(c => {
        const pct = c.total ? (c.remaining/c.total*100).toFixed(0) : 0;
        html += `<div class="pool-item" style="background:${color}22;border:1px solid ${color}44">
          ${c.name_kr}<br><span class="remaining">${c.remaining}/${c.total}</span></div>`;
      });
      html += '</div>';
    }
    el.innerHTML = html;
  } catch(e) { el.innerHTML = '<p style="color:red">ì˜¤ë¥˜</p>'; }
}

async function getLLMAnalysis() {
  const el = document.getElementById('llmResponse');
  el.textContent = 'ë¶„ì„ ì¤‘...';
  try {
    const resp = await fetch('/api/llm/analyze', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        my_champions: [...selectedChamps],
        level: parseInt(document.getElementById('levelSelect').value),
        gold: parseInt(document.getElementById('goldInput').value)
      })
    });
    const data = await resp.json();
    el.textContent = data.analysis || data.error || 'LLM ì‘ë‹µ ì—†ìŒ';
  } catch(e) { el.textContent = 'ì˜¤ë¥˜: ' + e.message; }
}

async function toggleCapture() {
  await fetch('/api/capture/toggle', {method: 'POST'});
  checkStatus();
}

async function saveSettings() {
  await fetch('/api/settings', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      capture_interval: parseFloat(document.getElementById('captureInterval').value),
      llm_url: document.getElementById('llmUrl').value
    })
  });
}

async function updateData() {
  const resp = await fetch('/api/update', {method: 'POST'});
  const data = await resp.json();
  alert(data.message);
  checkStatus();
}

async function checkStatus() {
  try {
    const [cap, llm, upd] = await Promise.all([
      fetch('/api/capture/status').then(r=>r.json()),
      fetch('/api/llm/status').then(r=>r.json()),
      fetch('/api/last_updated').then(r=>r.json()),
    ]);
    document.getElementById('captureStatus').className = 'status-dot ' + (cap.active ? 'active' : 'inactive');
    document.getElementById('llmStatus').className = 'status-dot ' + (llm.available ? 'active' : 'inactive');
    document.getElementById('lastUpdated').textContent = 'ì—…ë°ì´íŠ¸: ' + (upd.last_updated || '-');
  } catch(e) {}
}

checkStatus();
setInterval(checkStatus, 10000);
</script>
</body>
</html>
