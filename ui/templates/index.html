<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TFT ê°€ì´ë“œ</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
  <!-- ìƒíƒœë°” -->
  <header>
    <h1>âš”ï¸ TFT ê°€ì´ë“œ</h1>
    <div class="status-bar">
      <span class="status-item">
        <span class="status-dot" id="captureStatus"></span>
        ìº¡ì²˜ <span id="captureFps">-</span>
      </span>
      <span class="status-item">
        <span class="status-dot" id="llmStatus"></span> LLM
      </span>
      <span class="status-item">ğŸ¯ <span id="detectedCount">0</span>ëª… ì¸ì‹</span>
      <span class="status-item" id="lastUpdateTime" style="font-size:0.75rem;color:var(--text2)"></span>
    </div>
  </header>

  <div class="dashboard">
    <!-- ì¢Œì¸¡: ë³´ë“œ + ì¶”ì²œ -->
    <div class="main-col">
      <!-- ë‚´ ë³´ë“œ -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ¯ ë‚´ ë³´ë“œ</h2>
          <div class="input-group compact">
            <label>Lv</label>
            <select id="levelSelect">
              {% for l in range(2, 11) %}<option value="{{ l }}" {{ 'selected' if l == 7 }}>{{ l }}</option>{% endfor %}
            </select>
            <label>ğŸ’°</label>
            <input type="number" id="goldInput" value="0" min="0" max="999" style="width:60px">
            <button class="btn-sm" onclick="clearSelection()">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ë³´ë“œ ì‹œê°í™” -->
        <div class="board-display" id="boardDisplay">
          <p class="placeholder">ì±”í”¼ì–¸ì„ ì„ íƒí•˜ê±°ë‚˜ ìº¡ì²˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
        </div>

        <!-- ì±”í”¼ì–¸ ì„ íƒ ê·¸ë¦¬ë“œ -->
        <div class="champ-selector">
          <div class="cost-group" id="champGrid">
            {% for cost in [1,2,3,4,5] %}
            <div class="cost-section">
              <div class="cost-label" style="color:{{ cost_colors[cost] }}">{{ cost }}ì½”ìŠ¤íŠ¸</div>
              <div class="cost-champs">
                {% for champ in champions if champ.cost == cost %}
                <div class="champ-card cost-{{ champ.cost }}" data-name="{{ champ.name }}"
                     data-api="{{ champ.get('apiName', '') }}" onclick="toggleChamp(this)">
                  {% if champ.get('apiName') %}
                  <img src="/static/icons/TFT16_{{ champ.apiName }}.png" alt="{{ champ.name_kr }}"
                       loading="lazy" onerror="this.style.display='none'">
                  {% endif %}
                  <span class="champ-name">{{ champ.name_kr }}</span>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- ì¶”ì²œ ë± -->
      <div class="card">
        <h2>ğŸ“Š ì¶”ì²œ ë±</h2>
        <div id="recommendations">
          <p class="placeholder">ì±”í”¼ì–¸ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì¶”ì²œë©ë‹ˆë‹¤</p>
        </div>
      </div>
    </div>

    <!-- ìš°ì¸¡: AIì½”ì¹˜ + ìƒëŒ€ + í’€ + ì„¤ì • -->
    <div class="side-col">
      <!-- AI ì½”ì¹˜ -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ’¡ AI ì½”ì¹˜</h2>
          <button class="btn-sm primary" onclick="getLLMAnalysis()">ë¶„ì„ ìš”ì²­</button>
        </div>
        <div class="ai-response" id="llmResponse">
          <p class="placeholder">ì¶”ì²œ ë°›ê¸° í›„ AI ë¶„ì„ì„ ìš”ì²­í•˜ì„¸ìš”</p>
        </div>
        <div class="ai-source" id="aiSource"></div>
      </div>

      <!-- ìƒëŒ€ ë± -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ‘¥ ìƒëŒ€ ì •ë³´</h2>
          <button class="btn-sm" onclick="addOpponent()">+ ì¶”ê°€</button>
        </div>
        <div id="opponentInputs">
          <div class="input-group">
            <input type="text" placeholder="ìƒëŒ€1: ì±”í”¼ì–¸ëª… ì‰¼í‘œ êµ¬ë¶„" class="opp-input">
          </div>
        </div>
      </div>

      <!-- ì±”í”¼ì–¸ í’€ -->
      <div class="card collapsible">
        <div class="card-header clickable" onclick="toggleSection('poolSection')">
          <h2>ğŸŠ ì±”í”¼ì–¸ í’€</h2>
          <span class="collapse-icon" id="poolSectionIcon">â–¶</span>
        </div>
        <div id="poolSection" class="collapsed">
          <button class="btn-sm" onclick="loadPool()" style="margin-bottom:8px">í’€ ì¡°íšŒ</button>
          <div id="poolDisplay"></div>
        </div>
      </div>

      <!-- ì„¤ì • -->
      <div class="card collapsible">
        <div class="card-header clickable" onclick="toggleSection('settingsSection')">
          <h2>âš™ï¸ ì„¤ì •</h2>
          <span class="collapse-icon" id="settingsSectionIcon">â–¶</span>
        </div>
        <div id="settingsSection" class="collapsed">
          <div class="settings-grid">
            <label>ìº¡ì²˜ ì£¼ê¸°(ì´ˆ)</label>
            <input type="number" id="captureInterval" value="2" min="0.5" max="10" step="0.5">
            <label>ë§¤ì¹­ ì„ê³„ê°’</label>
            <input type="number" id="matchThreshold" value="0.7" min="0.3" max="1.0" step="0.05">
            <label>LLM ì„œë²„</label>
            <input type="text" id="llmUrl" value="http://localhost:11434/v1">
          </div>
          <div class="settings-actions">
            <button class="btn-sm" onclick="saveSettings()">ì €ì¥</button>
            <button class="btn-sm" onclick="toggleCapture()" id="captureToggleBtn">ìº¡ì²˜ ì‹œì‘</button>
            <button class="btn-sm" onclick="updateData()">ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const costColors = {{ cost_colors | tojson }};
const champData = {{ champions | tojson }};
let selectedChamps = new Set();
let pollingTimer = null;
let lastDetected = [];

// --- ì±”í”¼ì–¸ ì„ íƒ ---
function toggleChamp(el) {
  const name = el.dataset.name;
  if (selectedChamps.has(name)) {
    selectedChamps.delete(name);
    el.classList.remove('selected');
  } else {
    selectedChamps.add(name);
    el.classList.add('selected');
  }
  // ì„œë²„ì— ì•Œë¦¼
  fetch('/api/select_champion', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name, action: 'toggle'})
  });
  updateBoard();
  autoRecommend();
}

function clearSelection() {
  selectedChamps.clear();
  document.querySelectorAll('.champ-card.selected').forEach(e => e.classList.remove('selected'));
  fetch('/api/select_champion', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name: '', action: 'clear'})
  });
  document.getElementById('boardDisplay').innerHTML = '<p class="placeholder">ì±”í”¼ì–¸ì„ ì„ íƒí•˜ê±°ë‚˜ ìº¡ì²˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>';
  document.getElementById('recommendations').innerHTML = '<p class="placeholder">ì±”í”¼ì–¸ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì¶”ì²œë©ë‹ˆë‹¤</p>';
}

// --- ë³´ë“œ ì‹œê°í™” ---
function updateBoard() {
  const board = document.getElementById('boardDisplay');
  const allChamps = [...selectedChamps];
  // ì¸ì‹ëœ ì±”í”¼ì–¸ ì¶”ê°€
  lastDetected.forEach(d => {
    if (!allChamps.includes(d.name)) allChamps.push(d.name);
  });

  if (allChamps.length === 0) {
    board.innerHTML = '<p class="placeholder">ì±”í”¼ì–¸ì„ ì„ íƒí•˜ê±°ë‚˜ ìº¡ì²˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>';
    return;
  }

  board.innerHTML = allChamps.map(name => {
    const c = champData.find(ch => ch.name === name);
    if (!c) return '';
    const api = c.apiName || '';
    const isDetected = lastDetected.some(d => d.name === name);
    const isManual = selectedChamps.has(name);
    const badge = isDetected ? '<span class="detect-badge">ğŸ“¸</span>' : '';
    return `<div class="board-champ cost-${c.cost}">
      ${api ? `<img src="/static/icons/TFT16_${api}.png" alt="${c.name_kr}">` : ''}
      <span>${c.name_kr}</span>
      ${badge}
    </div>`;
  }).join('');
}

// --- ìë™ ì¶”ì²œ ---
let recDebounce = null;
function autoRecommend() {
  clearTimeout(recDebounce);
  recDebounce = setTimeout(() => {
    if (selectedChamps.size === 0 && lastDetected.length === 0) return;
    getRecommendation();
  }, 300);
}

function getOpponents() {
  const inputs = document.querySelectorAll('.opp-input');
  return [...inputs].map(i => i.value.split(',').map(s => s.trim()).filter(Boolean)).filter(a => a.length);
}

async function getRecommendation() {
  const level = parseInt(document.getElementById('levelSelect').value);
  const allChamps = [...selectedChamps];
  lastDetected.forEach(d => {
    if (!allChamps.includes(d.name)) allChamps.push(d.name);
  });
  if (allChamps.length === 0) return;

  const el = document.getElementById('recommendations');
  try {
    const resp = await fetch('/api/recommend', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({my_champions: allChamps, opponents: getOpponents(), level})
    });
    const data = await resp.json();
    renderRecommendations(data.recommendations);
  } catch(e) {
    el.innerHTML = `<p class="error">ì˜¤ë¥˜: ${e.message}</p>`;
  }
}

function renderRecommendations(recs) {
  const el = document.getElementById('recommendations');
  if (!recs || !recs.length) {
    el.innerHTML = '<p class="placeholder">ì¶”ì²œ ê²°ê³¼ ì—†ìŒ</p>';
    return;
  }
  el.innerHTML = recs.slice(0, 5).map((r, i) => {
    const tierClass = 'tier-' + r.tier;
    const needed = r.needed_champions.map(n => {
      const c = champData.find(ch => ch.name === n.name);
      const cost = c ? c.cost : 1;
      const prob = (n.shop_probability * 100).toFixed(1);
      return `<span class="champ-mini cost-${cost}">ğŸ” ${c ? c.name_kr || n.name : n.name} <small>${prob}%</small></span>`;
    }).join('');
    const owned = r.owned_champions.map(n => {
      const c = champData.find(ch => ch.name === n);
      const cost = c ? c.cost : 1;
      return `<span class="champ-mini cost-${cost} owned">âœ… ${c ? c.name_kr || n : n}</span>`;
    }).join('');
    const matchPct = (r.match_rate * 100).toFixed(0);
    const scorePct = (r.completion_score * 100).toFixed(0);

    return `<div class="deck-card ${i === 0 ? 'top-pick' : ''}">
      <div class="deck-header">
        <span class="deck-name">${i === 0 ? 'â­ ' : ''}${r.deck_name}</span>
        <span class="tier ${tierClass}">${r.tier}</span>
      </div>
      <div class="deck-stats">
        <span>ìŠ¹ë¥  ${r.win_rate}%</span>
        <span>í”½ë¥  ${r.pick_rate}%</span>
        <span>ìŠ¤ì½”ì–´ ${scorePct}</span>
      </div>
      <div class="match-bar"><div class="match-fill" style="width:${matchPct}%"></div><span class="match-label">${matchPct}%</span></div>
      <div class="deck-champs-section">
        <div>${owned || ''}</div>
        <div>${needed || '<span class="complete-badge">ğŸ‰ ì™„ì„±!</span>'}</div>
      </div>
    </div>`;
  }).join('');
}

function getCost(name) {
  const c = champData.find(ch => ch.name === name);
  return c ? c.cost : 1;
}

// --- AI ì½”ì¹˜ ---
async function getLLMAnalysis() {
  const el = document.getElementById('llmResponse');
  const src = document.getElementById('aiSource');
  el.innerHTML = '<div class="spinner"></div> ë¶„ì„ ì¤‘...';
  src.textContent = '';
  try {
    const resp = await fetch('/api/llm/analyze', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        my_champions: [...selectedChamps],
        level: parseInt(document.getElementById('levelSelect').value),
        gold: parseInt(document.getElementById('goldInput').value)
      })
    });
    const data = await resp.json();
    el.textContent = data.analysis || data.error || 'ì‘ë‹µ ì—†ìŒ';
    if (data.source) {
      src.textContent = data.source === 'llm' ? 'ğŸ¤– LLM ë¶„ì„' : 'ğŸ“‹ ë£° ê¸°ë°˜ ì¡°ì–¸';
      src.className = 'ai-source ' + data.source;
    }
  } catch(e) {
    el.textContent = 'ì˜¤ë¥˜: ' + e.message;
  }
}

// --- ìƒëŒ€ ---
function addOpponent() {
  const div = document.getElementById('opponentInputs');
  const n = div.children.length + 1;
  const row = document.createElement('div');
  row.className = 'input-group';
  row.innerHTML = `<input type="text" placeholder="ìƒëŒ€${n}: ì±”í”¼ì–¸ëª… ì‰¼í‘œ êµ¬ë¶„" class="opp-input">`;
  div.appendChild(row);
}

// --- ì±”í”¼ì–¸ í’€ ---
async function loadPool() {
  const el = document.getElementById('poolDisplay');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const resp = await fetch('/api/pool', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({opponents: getOpponents()})
    });
    const data = await resp.json();
    let html = '';
    for (const [cost, champs] of Object.entries(data.pool)) {
      const color = costColors[cost] || '#808080';
      html += `<div class="pool-cost-group"><div class="pool-cost-label" style="color:${color}">${cost}ì½”</div><div class="pool-grid">`;
      champs.forEach(c => {
        const pct = c.total ? Math.round(c.remaining / c.total * 100) : 0;
        const opacity = pct < 50 ? 'low-pool' : '';
        html += `<div class="pool-item ${opacity}" style="border-color:${color}40">
          <span class="pool-name">${c.name_kr}</span>
          <span class="pool-count">${c.remaining}/${c.total}</span>
        </div>`;
      });
      html += '</div></div>';
    }
    el.innerHTML = html;
  } catch(e) { el.innerHTML = '<p class="error">ì˜¤ë¥˜</p>'; }
}

// --- ì„¤ì • ---
async function toggleCapture() {
  const resp = await fetch('/api/capture/toggle', {method: 'POST'});
  const data = await resp.json();
  updateCaptureUI(data);
}

async function saveSettings() {
  await fetch('/api/settings', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      capture_interval: parseFloat(document.getElementById('captureInterval').value),
      threshold: parseFloat(document.getElementById('matchThreshold').value),
      llm_url: document.getElementById('llmUrl').value
    })
  });
}

async function updateData() {
  const resp = await fetch('/api/update', {method: 'POST'});
  const data = await resp.json();
  alert(data.message);
}

function toggleSection(id) {
  const el = document.getElementById(id);
  const icon = document.getElementById(id + 'Icon');
  el.classList.toggle('collapsed');
  icon.textContent = el.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
}

// --- ì‹¤ì‹œê°„ í´ë§ ---
function updateCaptureUI(cap) {
  const dot = document.getElementById('captureStatus');
  const fps = document.getElementById('captureFps');
  const btn = document.getElementById('captureToggleBtn');
  const count = document.getElementById('detectedCount');

  dot.className = 'status-dot ' + (cap.active ? 'active' : 'inactive');
  fps.textContent = cap.active ? `${cap.fps || 0} FPS` : 'ì¤‘ì§€';
  btn.textContent = cap.active ? 'ìº¡ì²˜ ì¤‘ì§€' : 'ìº¡ì²˜ ì‹œì‘';
  count.textContent = cap.detected_count || 0;
}

async function pollStatus() {
  try {
    const resp = await fetch('/api/status');
    const data = await resp.json();

    // ìº¡ì²˜ ìƒíƒœ
    updateCaptureUI(data.capture);

    // ì¸ì‹ëœ ì±”í”¼ì–¸ ì—…ë°ì´íŠ¸
    if (data.detected_champions && data.detected_champions.length > 0) {
      lastDetected = data.detected_champions;
      updateBoard();
    }

    // ì‹œê°„ í‘œì‹œ
    if (data.timestamp) {
      const d = new Date(data.timestamp * 1000);
      document.getElementById('lastUpdateTime').textContent =
        d.toLocaleTimeString('ko-KR');
    }
  } catch(e) {}
}

async function checkLLMStatus() {
  try {
    const resp = await fetch('/api/llm/status');
    const data = await resp.json();
    document.getElementById('llmStatus').className =
      'status-dot ' + (data.available ? 'active' : 'inactive');
  } catch(e) {}
}

// ë ˆë²¨/ê³¨ë“œ ë³€ê²½ ì‹œ ì„œë²„ì— ë™ê¸°í™”
document.getElementById('levelSelect').addEventListener('change', () => {
  syncLevelGold();
  autoRecommend();
});
document.getElementById('goldInput').addEventListener('change', syncLevelGold);

function syncLevelGold() {
  fetch('/api/set_level', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      level: parseInt(document.getElementById('levelSelect').value),
      gold: parseInt(document.getElementById('goldInput').value)
    })
  });
}

// ì´ˆê¸°í™”
pollStatus();
checkLLMStatus();
pollingTimer = setInterval(pollStatus, 2000);
setInterval(checkLLMStatus, 30000);
</script>
</body>
</html>
